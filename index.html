<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Task Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>

    <style>
        :root {
            --background-light: 220 20% 96%;
            --foreground-light: 220 20% 10%;
            --card-light: 220 20% 100%;
            --primary-light: 207 85% 68%;
            --primary-foreground-light: 0 0% 100%;
            --secondary-light: 220 20% 91%;
            --accent-light: 174 45% 51%;
            --border-light: 220 20% 85%;
            --destructive-light: 0 84% 60%;

            --background-dark: 222 47% 11%;
            --foreground-dark: 210 40% 98%;
            --card-dark: 222 47% 14%;
            --primary-dark: 207 85% 68%;
            --primary-foreground-dark: 0 0% 100%;
            --secondary-dark: 217 33% 17%;
            --accent-dark: 174 45% 51%;
            --border-dark: 217 33% 22%;
            --destructive-dark: 0 63% 31%;

            --background: hsl(var(--background-light));
            --foreground: hsl(var(--foreground-light));
            --card: hsl(var(--card-light));
            --primary: hsl(var(--primary-light));
            --primary-foreground: hsl(var(--primary-foreground-light));
            --secondary: hsl(var(--secondary-light));
            --accent: hsl(var(--accent-light));
            --border: hsl(var(--border-light));
            --destructive: hsl(var(--destructive-light));
            
            --radius: 0.5rem;
            --font-family: 'Inter', sans-serif;
        }

        .dark {
            --background: hsl(var(--background-dark));
            --foreground: hsl(var(--foreground-dark));
            --card: hsl(var(--card-dark));
            --primary: hsl(var(--primary-dark));
            --primary-foreground: hsl(var(--primary-foreground-dark));
            --secondary: hsl(var(--secondary-dark));
            --accent: hsl(var(--accent-dark));
            --border: hsl(var(--border-dark));
            --destructive: hsl(var(--destructive-dark));
        }

        *, *::before, *::after { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: var(--font-family);
            background-color: var(--background);
            color: var(--foreground);
            transition: background-color 0.2s, color 0.2s;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .hidden { display: none !important; }

        /* Header */
        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid var(--border);
            background-color: var(--background);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .header-left, .header-right, .header-center { display: flex; align-items: center; gap: 1rem; }
        .app-header h1 { font-size: 1.5rem; margin: 0; }
        .app-header .btn {
            background-color: transparent;
            color: var(--foreground);
            border: 1px solid var(--border);
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .app-header .btn:hover { background-color: var(--secondary); }
        .app-header .btn.active { background-color: var(--primary); color: var(--primary-foreground); border-color: var(--primary); }
        .app-header .btn.destructive { border-color: var(--destructive); color: var(--destructive); }
        .app-header .btn.destructive.active { background-color: var(--destructive); color: var(--foreground); }
        
        /* Main Content */
        #main-content {
            flex-grow: 1;
            display: flex;
            overflow-x: auto;
            padding: 1rem;
        }

        /* Kanban Board */
        #kanban-board {
            display: flex;
            gap: 1rem;
            width: 100%;
            align-items: flex-start;
        }
        .kanban-column {
            display: flex;
            flex-direction: column;
            width: 300px;
            flex-shrink: 0;
            background-color: var(--secondary);
            border-radius: var(--radius);
            padding: 0.5rem;
        }
        .kanban-column-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            font-weight: 600;
        }
        .kanban-column-color {
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 50%;
        }
        .kanban-tasks {
            flex-grow: 1;
            min-height: 100px;
            padding-top: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .task-card {
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            cursor: grab;
            transition: box-shadow 0.2s;
        }
        .task-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .task-card.overdue { border-left: 4px solid var(--destructive); }
        .task-card.dragging { opacity: 0.5; }
        .task-card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .task-card-header h3 { font-size: 1rem; margin: 0; }
        .task-card .importance-dot { width: 0.75rem; height: 0.75rem; border-radius: 50%; flex-shrink: 0; margin-top: 0.25rem; }
        .task-card .task-id { font-size: 0.75rem; color: #888; margin-top: 0.25rem; }
        .task-card-footer { display: flex; justify-content: space-between; font-size: 0.75rem; color: #888; margin-top: 1rem; }
        .task-card .sub-status-badge {
            background-color: var(--secondary);
            border: 1px solid var(--border);
            padding: 0.2rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.7rem;
            margin-top: 0.5rem;
            display: inline-block;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background-color: var(--card);
            margin: auto;
            padding: 2rem;
            border: 1px solid var(--border);
            width: 90%;
            max-width: 600px;
            border-radius: var(--radius);
            position: relative;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .modal-header h2 { margin: 0; }
        .close-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--foreground);
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { font-weight: 500; font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid var(--border);
            background-color: var(--background);
            color: var(--foreground);
            border-radius: var(--radius);
            font-size: 1rem;
        }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .modal-footer {
            margin-top: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-footer .btn {
             padding: 0.6rem 1.2rem;
             border: 1px solid var(--border);
             background-color: transparent;
             color: var(--foreground);
             border-radius: var(--radius);
             cursor: pointer;
        }
        .modal-footer .btn-primary {
            background-color: var(--primary);
            color: var(--primary-foreground);
            border-color: var(--primary);
        }
        .modal-footer .btn-destructive {
            background-color: var(--destructive);
            color: var(--primary-foreground);
            border: none;
        }

        /* Dashboard */
        #dashboard-view {
            width: 100%;
            padding: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
        }
        .chart-container, .table-container {
            background-color: var(--card);
            padding: 1.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }
        .chart-container h3, .table-container h3 { margin-top: 0; }
        .table-container { grid-column: 1 / -1; }
        .table-container input {
            width: 300px;
            padding: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
            background-color: var(--background);
            color: var(--foreground);
            border-radius: var(--radius);
        }
        #completed-tasks-table { width: 100%; border-collapse: collapse; }
        #completed-tasks-table th, #completed-tasks-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        #completed-tasks-table th { font-weight: 600; cursor: pointer; }
        #completed-tasks-table th:hover { background-color: var(--secondary); }

        /* Settings */
        #settings-view { width: 100%; padding: 1rem; }
        .settings-tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 1.5rem; }
        .settings-tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }
        .settings-tab.active { border-color: var(--primary); color: var(--primary); font-weight: 600; }
        .settings-content { display: none; }
        .settings-content.active { display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); }
        .settings-card {
            background-color: var(--card);
            padding: 1.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }
        .settings-card h3 { margin-top: 0; }
        .settings-card .btn {
            background-color: var(--primary);
            color: var(--primary-foreground);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            cursor: pointer;
        }
        .settings-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .settings-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background-color: var(--secondary);
            border-radius: var(--radius);
        }
        .settings-list-item .item-details { display: flex; align-items: center; gap: 0.75rem; }
        .settings-list-item .item-color-preview { width: 1rem; height: 1rem; border-radius: 50%; border: 1px solid var(--border); }
        .settings-list-item .item-actions .btn-icon { background: none; border: none; cursor: pointer; color: var(--foreground); padding: 0.25rem; }

        /* Loader */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--background);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>

    <div id="loader">Loading Application...</div>

    <div id="app-container" class="hidden">
        <header class="app-header">
            <div class="header-left">
                <h1>Task Tracker</h1>
                <button id="theme-toggle" class="btn">üåì</button>
            </div>
            <div class="header-center" id="kanban-filters">
                <button class="btn filter-btn" data-filter="active">Active</button>
                <button class="btn filter-btn destructive" data-filter="overdue">Overdue</button>
                <button class="btn filter-btn" data-filter="due-today">Due Today</button>
                <button class="btn filter-btn" data-filter="due-this-week">Due This Week</button>
            </div>
            <div class="header-right">
                <button id="new-task-btn" class="btn">New Task</button>
                <button id="dashboard-toggle-btn" class="btn">Dashboard</button>
                <button id="settings-toggle-btn" class="btn">Settings</button>
            </div>
        </header>

        <main id="main-content">
            <div id="kanban-board"></div>
            <div id="dashboard-view" class="hidden">
                <div class="chart-container">
                    <h3>Weekly Completion Trend</h3>
                    <canvas id="weekly-completion-chart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Active Task Distribution</h3>
                    <canvas id="task-distribution-chart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Performance by Bid Origin</h3>
                    <canvas id="bid-origin-chart"></canvas>
                </div>
                <div class="table-container">
                    <h3>Completed Tasks</h3>
                    <input type="text" id="completed-tasks-search" placeholder="Search completed tasks...">
                    <table id="completed-tasks-table">
                        <thead>
                            <tr>
                                <th data-sort="taskid">Task ID</th>
                                <th data-sort="title">Title</th>
                                <th data-sort="completionDate">Completion Date</th>
                                <th data-sort="remarks">Remarks</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
             <div id="settings-view" class="hidden">
                <div class="settings-tabs">
                    <div class="settings-tab active" data-tab="workflow">Workflow</div>
                    <div class="settings-tab" data-tab="sub-categories">Sub-Categories</div>
                    <div class="settings-tab" data-tab="importance">Importance</div>
                    <div class="settings-tab" data-tab="bid-origins">Bid Origins</div>
                    <div class="settings-tab" data-tab="data-management">Data Management</div>
                </div>

                <div id="workflow-content" class="settings-content active">
                    <div class="settings-card">
                        <h3>Workflow Categories</h3>
                        <p>Define the columns for your Kanban board.</p>
                        <button id="add-workflow-btn" class="btn">Add New Category</button>
                        <ul id="workflow-list" class="settings-list"></ul>
                    </div>
                </div>
                <div id="sub-categories-content" class="settings-content">
                    <div class="settings-card">
                        <h3>Sub-Categories</h3>
                        <p>Define sub-statuses for your workflow categories.</p>
                         <button id="add-subcategory-btn" class="btn">Add New Sub-Category</button>
                        <ul id="subcategory-list" class="settings-list"></ul>
                    </div>
                </div>
                 <div id="importance-content" class="settings-content">
                    <div class="settings-card">
                        <h3>Importance Levels</h3>
                        <p>Define priority levels for your tasks.</p>
                         <button id="add-importance-btn" class="btn">Add New Level</button>
                        <ul id="importance-list" class="settings-list"></ul>
                    </div>
                </div>
                 <div id="bid-origins-content" class="settings-content">
                    <div class="settings-card">
                        <h3>Bid Origins</h3>
                        <p>Define the sources for your tasks.</p>
                         <button id="add-bid-origin-btn" class="btn">Add New Origin</button>
                        <ul id="bid-origin-list" class="settings-list"></ul>
                    </div>
                </div>
                <div id="data-management-content" class="settings-content">
                    <div class="settings-card">
                        <h3>Data Management</h3>
                        <button id="import-data-btn" class="btn">Import Data (JSON)</button>
                        <input type="file" id="import-file-input" class="hidden" accept=".json">
                        <button id="export-data-btn" class="btn">Export Data (JSON)</button>
                    </div>
                    <div class="settings-card">
                        <h3 style="color: var(--destructive)">Danger Zone</h3>
                        <button id="clear-tasks-btn" class="btn btn-destructive">Clear All Tasks</button>
                        <button id="reset-settings-btn" class="btn btn-destructive">Reset Settings</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Task Modal -->
    <div id="task-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">New Task</h2>
                <button class="close-button">&times;</button>
            </div>
            <form id="task-form">
                <input type="hidden" id="task-id">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="task-taskid">Task ID</label>
                        <input type="text" id="task-taskid" required>
                    </div>
                    <div class="form-group">
                        <label for="task-title">Title / Description</label>
                        <input type="text" id="task-title" required>
                    </div>
                    <div class="form-group">
                        <label for="task-date">Start Date</label>
                        <input type="date" id="task-date" required>
                    </div>
                    <div class="form-group">
                        <label for="task-dueDate">Due Date</label>
                        <input type="date" id="task-dueDate" required>
                    </div>
                    <div class="form-group">
                        <label for="task-status">Status</label>
                        <select id="task-status" required></select>
                    </div>
                    <div class="form-group">
                        <label for="task-subStatus">Sub-Status</label>
                        <select id="task-subStatus"></select>
                    </div>
                    <div class="form-group">
                        <label for="task-importance">Importance</label>
                        <select id="task-importance" required></select>
                    </div>
                    <div class="form-group">
                        <label for="task-bidOrigin">Bid Origin</label>
                        <select id="task-bidOrigin" required></select>
                    </div>
                     <div class="form-group full-width">
                        <label for="task-remarks">Remarks</label>
                        <textarea id="task-remarks"></textarea>
                    </div>
                </div>
            </form>
            <div class="modal-footer">
                <button id="delete-task-btn" class="btn btn-destructive hidden">Delete</button>
                <button id="save-task-btn" class="btn btn-primary">Save Task</button>
            </div>
        </div>
    </div>
    
    <!-- Settings Modals -->
    <div id="settings-modal" class="modal">
         <div class="modal-content">
             <div class="modal-header">
                <h2 id="settings-modal-title"></h2>
                <button class="close-button">&times;</button>
            </div>
            <form id="settings-form">
                <input type="hidden" id="settings-item-id">
                <div class="form-group full-width">
                    <label for="settings-name">Name</label>
                    <input type="text" id="settings-name" required>
                </div>
                <div id="settings-color-group" class="form-group full-width hidden">
                    <label for="settings-color">Color</label>
                    <input type="color" id="settings-color">
                </div>
                <div id="settings-parent-group" class="form-group full-width hidden">
                    <label for="settings-parent">Parent Category</label>
                    <select id="settings-parent"></select>
                </div>
            </form>
             <div class="modal-footer">
                <button id="settings-delete-btn" class="btn btn-destructive hidden">Delete</button>
                <button id="settings-save-btn" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, deleteDoc, onSnapshot, writeBatch, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Your Firebase Configuration ---
        const firebaseConfig = {
          "projectId": "kanbanflow-6cvc6",
          "appId": "1:674602332508:web:d5676390127c3e0b131199",
          "storageBucket": "kanbanflow-6cvc6.firebasestorage.app",
          "apiKey": "AIzaSyCX81iJOmn0Dn9lH5EkYZBdSYNXqlpDU1c",
          "authDomain": "kanbanflow-6cvc6.firebaseapp.com",
          "measurementId": "",
          "messagingSenderId": "674602332508"
        };

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tasksCollection = collection(db, 'tasks');
        const settingsDoc = doc(db, 'settings', 'appSettings');

        // --- State Management ---
        let allTasks = [];
        let settings = {};
        let currentKanbanFilter = 'active'; // Default filter
        
        const charts = {
            weekly: null,
            distribution: null,
            origin: null,
        };

        const defaultSettings = {
            workflowCategories: [
              { id: 'wc1', name: 'Not Started', color: '#EF4444' },
              { id: 'wc2', name: 'In Progress', color: '#F97316' },
              { id: 'wc3', name: 'Under Review', color: '#EAB308' },
              { id: 'wc4', name: 'Done', color: '#22C55E' },
            ],
            subCategories: [
              { id: 'sc1', name: 'Design', parentCategory: 'In Progress' },
              { id: 'sc2', name: 'Development', parentCategory: 'In Progress' },
              { id: 'sc3', name: 'QA', parentCategory: 'Under Review' },
            ],
            importanceLevels: [
              { id: 'il1', name: 'High', color: '#DC2626' },
              { id: 'il2', name: 'Medium', color: '#F59E0B' },
              { id: 'il3', name: 'Low', color: '#10B981' },
            ],
            bidOrigins: [
              { id: 'bo1', name: 'Client Request' },
              { id: 'bo2', name: 'Internal' },
              { id: 'bo3', name: 'Referral' },
            ],
        };

        // --- UI Element References ---
        const DOMElements = {
            loader: document.getElementById('loader'),
            appContainer: document.getElementById('app-container'),
            themeToggle: document.getElementById('theme-toggle'),
            kanbanBoard: document.getElementById('kanban-board'),
            dashboardView: document.getElementById('dashboard-view'),
            settingsView: document.getElementById('settings-view'),
            mainContent: document.getElementById('main-content'),
            newTaskBtn: document.getElementById('new-task-btn'),
            dashboardToggleBtn: document.getElementById('dashboard-toggle-btn'),
            settingsToggleBtn: document.getElementById('settings-toggle-btn'),
            
            // Modal
            taskModal: document.getElementById('task-modal'),
            modalTitle: document.getElementById('modal-title'),
            taskForm: document.getElementById('task-form'),
            taskIdInput: document.getElementById('task-id'),
            taskTaskIdInput: document.getElementById('task-taskid'),
            taskTitleInput: document.getElementById('task-title'),
            taskDateInput: document.getElementById('task-date'),
            taskDueDateInput: document.getElementById('task-dueDate'),
            taskStatusInput: document.getElementById('task-status'),
            taskSubStatusInput: document.getElementById('task-subStatus'),
            taskImportanceInput: document.getElementById('task-importance'),
            taskBidOriginInput: document.getElementById('task-bidOrigin'),
            taskRemarksTextarea: document.getElementById('task-remarks'),
            saveTaskBtn: document.getElementById('save-task-btn'),
            deleteTaskBtn: document.getElementById('delete-task-btn'),
            closeModalBtns: document.querySelectorAll('.close-button'),
            
            // Settings
            settingsTabs: document.querySelectorAll('.settings-tab'),
            settingsContents: document.querySelectorAll('.settings-content'),
            workflowList: document.getElementById('workflow-list'),
            subcategoryList: document.getElementById('subcategory-list'),
            importanceList: document.getElementById('importance-list'),
            bidOriginList: document.getElementById('bid-origin-list'),
            
            // Settings Modals
            settingsModal: document.getElementById('settings-modal'),
            settingsModalTitle: document.getElementById('settings-modal-title'),
            settingsForm: document.getElementById('settings-form'),
            settingsItemId: document.getElementById('settings-item-id'),
            settingsNameInput: document.getElementById('settings-name'),
            settingsColorGroup: document.getElementById('settings-color-group'),
            settingsColorInput: document.getElementById('settings-color'),
            settingsParentGroup: document.getElementById('settings-parent-group'),
            settingsParentSelect: document.getElementById('settings-parent'),
            settingsSaveBtn: document.getElementById('settings-save-btn'),
            settingsDeleteBtn: document.getElementById('settings-delete-btn'),
        };

        // --- Utility Functions ---
        const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

        // --- Theme Management ---
        const applyTheme = () => {
            const isDarkMode = localStorage.getItem('theme') === 'dark';
            document.documentElement.classList.toggle('dark', isDarkMode);
        };

        const toggleTheme = () => {
            const isDarkMode = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDarkMode ? 'light' : 'dark');
            applyTheme();
        };

        // --- Main App Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
        });
        
        function initApp() {
            applyTheme();
            addEventListeners();
            loadInitialData();
        }

        async function loadInitialData() {
            try {
                // Check if settings exist
                const settingsSnapshot = await getDoc(settingsDoc);
                if (!settingsSnapshot.exists()) {
                    console.log("No settings found. Initializing with default settings.");
                    await setDoc(settingsDoc, defaultSettings);
                    settings = defaultSettings;
                } else {
                    settings = settingsSnapshot.data();
                }

                // Setup listeners
                onSnapshot(settingsDoc, (doc) => {
                    console.log("Settings updated.");
                    settings = doc.data();
                    renderAll();
                });

                onSnapshot(query(tasksCollection), (snapshot) => {
                    console.log("Tasks updated.");
                    allTasks = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    renderAll();
                });
                
            } catch (error) {
                console.error("Error loading initial data:", error);
            } finally {
                DOMElements.loader.classList.add('hidden');
                DOMElements.appContainer.classList.remove('hidden');
            }
        }
        
        function renderAll() {
             renderKanbanBoard();
             updateHeaderStats();
             if(!DOMElements.dashboardView.classList.contains('hidden')) {
                 renderDashboard();
             }
             if(!DOMElements.settingsView.classList.contains('hidden')) {
                 renderSettings();
             }
        }
        
        // --- Kanban Board Rendering ---
        function renderKanbanBoard() {
            DOMElements.kanbanBoard.innerHTML = '';
            if (!settings.workflowCategories) return;

            const filteredTasks = getFilteredTasks();

            settings.workflowCategories.forEach(category => {
                const column = document.createElement('div');
                column.className = 'kanban-column';
                column.dataset.status = category.name;

                const header = document.createElement('div');
                header.className = 'kanban-column-header';
                const tasksForColumn = filteredTasks.filter(task => task.status === category.name);
                header.innerHTML = `
                    <div class="kanban-column-color" style="background-color: ${category.color};"></div>
                    <span>${category.name} (${tasksForColumn.length})</span>
                `;
                column.appendChild(header);

                const tasksContainer = document.createElement('div');
                tasksContainer.className = 'kanban-tasks';
                column.appendChild(tasksContainer);

                tasksForColumn.forEach(task => {
                    tasksContainer.appendChild(createTaskCard(task));
                });
                
                // Drag and Drop
                column.addEventListener('dragover', e => e.preventDefault());
                column.addEventListener('drop', handleDrop);

                DOMElements.kanbanBoard.appendChild(column);
            });
        }
        
        function createTaskCard(task) {
            const card = document.createElement('div');
            card.className = 'task-card';
            card.dataset.taskId = task.id;
            card.draggable = true;
            
            const isOverdue = new Date(task.dueDate) < new Date() && task.status.toLowerCase() !== 'done';
            if (isOverdue) card.classList.add('overdue');
            
            const importance = settings.importanceLevels.find(l => l.name === task.importance);
            
            card.innerHTML = `
                <div class="task-card-header">
                    <h3>${task.title}</h3>
                    ${importance ? `<div class="importance-dot" style="background-color: ${importance.color}" title="Importance: ${importance.name}"></div>` : ''}
                </div>
                <p class="task-id">${task.taskid}</p>
                ${task.subStatus ? `<div class="sub-status-badge">${task.subStatus}</div>` : ''}
                <div class="task-card-footer">
                    <span>Start: ${formatDate(task.date)}</span>
                    <span>Due: ${formatDate(task.dueDate)}</span>
                </div>
            `;
            
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('click', () => openTaskModal(task));
            return card;
        }
        
        function getFilteredTasks() {
            const now = new Date();
            const today = dateFns.startOfDay(now);
            const startOfWeek = dateFns.startOfWeek(today);
            const endOfWeek = dateFns.endOfWeek(today);

            switch (currentKanbanFilter) {
                case "active":
                    return allTasks.filter(task => task.status.toLowerCase() !== "done");
                case "overdue":
                    return allTasks.filter(task => new Date(task.dueDate) < today && task.status.toLowerCase() !== "done");
                case "due-today":
                    return allTasks.filter(task => dateFns.isSameDay(new Date(task.dueDate), today));
                case "due-this-week":
                    return allTasks.filter(task => {
                        const dueDate = new Date(task.dueDate);
                        return dueDate >= startOfWeek && dueDate <= endOfWeek;
                    });
                case "all":
                default:
                    return allTasks;
            }
        }

        // --- Drag and Drop Handlers ---
        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.taskId);
            e.target.classList.add('dragging');
        }

        async function handleDrop(e) {
            e.preventDefault();
            const taskId = e.dataTransfer.getData('text/plain');
            const targetColumn = e.target.closest('.kanban-column');
            document.querySelector('.dragging')?.classList.remove('dragging');

            if (!targetColumn) return;

            const newStatus = targetColumn.dataset.status;
            const task = allTasks.find(t => t.id === taskId);
            
            if (task && task.status !== newStatus) {
                const updatedTask = { ...task, status: newStatus };
                if (newStatus.toLowerCase() === 'done' && !task.completionDate) {
                    updatedTask.completionDate = new Date().toISOString();
                }
                
                try {
                    await setDoc(doc(db, 'tasks', taskId), updatedTask);
                } catch (error) {
                    console.error("Error updating task status:", error);
                }
            }
        }
        
        // --- Header Stats ---
        function updateHeaderStats() {
            const now = new Date();
            const today = dateFns.startOfDay(now);
            const startOfWeek = dateFns.startOfWeek(today);
            const endOfWeek = dateFns.endOfWeek(today);

            const activeCount = allTasks.filter(t => t.status.toLowerCase() !== 'done').length;
            const overdueCount = allTasks.filter(t => new Date(t.dueDate) < today && t.status.toLowerCase() !== 'done').length;
            const dueTodayCount = allTasks.filter(t => dateFns.isSameDay(new Date(t.dueDate), today)).length;
            const dueThisWeekCount = allTasks.filter(t => {
                const d = new Date(t.dueDate);
                return d >= startOfWeek && d <= endOfWeek;
            }).length;

            document.querySelector('.filter-btn[data-filter="active"]').textContent = `Active (${activeCount})`;
            document.querySelector('.filter-btn[data-filter="overdue"]').textContent = `Overdue (${overdueCount})`;
            document.querySelector('.filter-btn[data-filter="due-today"]').textContent = `Due Today (${dueTodayCount})`;
            document.querySelector('.filter-btn[data-filter="due-this-week"]').textContent = `Due This Week (${dueThisWeekCount})`;
        }


        // --- View Toggling ---
        function toggleView(view) {
            const isSettings = view === 'settings';
            const isDashboard = view === 'dashboard';
            const isKanban = !isSettings && !isDashboard;
            
            DOMElements.dashboardView.classList.toggle('hidden', !isDashboard);
            DOMElements.settingsView.classList.toggle('hidden', !isSettings);
            DOMElements.kanbanBoard.classList.toggle('hidden', isDashboard || isSettings);
            
            document.getElementById('kanban-filters').style.visibility = isKanban ? 'visible' : 'hidden';

            if (isDashboard) renderDashboard();
            if (isSettings) renderSettings();
        }

        // --- Task Modal ---
        function openTaskModal(task = null) {
            DOMElements.taskForm.reset();
            populateSelect(DOMElements.taskStatusInput, settings.workflowCategories.map(c => c.name));
            populateSelect(DOMElements.taskImportanceInput, settings.importanceLevels.map(i => i.name));
            populateSelect(DOMElements.taskBidOriginInput, settings.bidOrigins.map(b => b.name));

            if (task) {
                DOMElements.modalTitle.textContent = 'Edit Task';
                DOMElements.taskIdInput.value = task.id;
                DOMElements.taskTaskIdInput.value = task.taskid;
                DOMElements.taskTitleInput.value = task.title;
                DOMElements.taskDateInput.value = task.date.split('T')[0];
                DOMElements.taskDueDateInput.value = task.dueDate.split('T')[0];
                DOMElements.taskStatusInput.value = task.status;
                updateSubStatusDropdown(task.status);
                DOMElements.taskSubStatusInput.value = task.subStatus || '';
                DOMElements.taskImportanceInput.value = task.importance;
                DOMElements.taskBidOriginInput.value = task.bidOrigin;
                DOMElements.taskRemarksTextarea.value = task.remarks;
                DOMElements.deleteTaskBtn.classList.remove('hidden');
            } else {
                DOMElements.modalTitle.textContent = 'New Task';
                DOMElements.taskIdInput.value = '';
                DOMElements.taskTaskIdInput.value = `PROJ-${Math.floor(1000 + Math.random() * 9000)}`;
                DOMElements.taskDateInput.value = new Date().toISOString().split('T')[0];
                DOMElements.deleteTaskBtn.classList.add('hidden');
                updateSubStatusDropdown(DOMElements.taskStatusInput.value);
            }
            DOMElements.taskModal.classList.add('show');
        }
        
        function closeTaskModal() {
            DOMElements.taskModal.classList.remove('show');
        }
        
        async function handleSaveTask(e) {
            e.preventDefault();
            const id = DOMElements.taskIdInput.value;
            
            const taskData = {
                taskid: DOMElements.taskTaskIdInput.value,
                title: DOMElements.taskTitleInput.value,
                date: new Date(DOMElements.taskDateInput.value).toISOString(),
                dueDate: new Date(DOMElements.taskDueDateInput.value).toISOString(),
                status: DOMElements.taskStatusInput.value,
                subStatus: DOMElements.taskSubStatusInput.value,
                importance: DOMElements.taskImportanceInput.value,
                bidOrigin: DOMElements.taskBidOriginInput.value,
                remarks: DOMElements.taskRemarksTextarea.value,
            };

            if (taskData.status.toLowerCase() === 'done' && (!id || !allTasks.find(t=>t.id===id).completionDate)) {
                 taskData.completionDate = new Date().toISOString();
            } else if (taskData.status.toLowerCase() !== 'done') {
                taskData.completionDate = null;
            }

            try {
                const docId = id || generateId();
                await setDoc(doc(db, 'tasks', docId), taskData);
                closeTaskModal();
            } catch (error) {
                console.error("Error saving task:", error);
                alert("Failed to save task.");
            }
        }
        
        async function handleDeleteTask() {
            const id = DOMElements.taskIdInput.value;
            if (id && confirm('Are you sure you want to delete this task?')) {
                try {
                    await deleteDoc(doc(db, 'tasks', id));
                    closeTaskModal();
                } catch (error) {
                    console.error("Error deleting task:", error);
                    alert("Failed to delete task.");
                }
            }
        }
        
        function updateSubStatusDropdown(selectedStatus) {
            const relevantSubStatuses = settings.subCategories.filter(sc => sc.parentCategory === selectedStatus).map(sc => sc.name);
            populateSelect(DOMElements.taskSubStatusInput, relevantSubStatuses, 'No Sub-Status');
            DOMElements.taskSubStatusInput.disabled = relevantSubStatuses.length === 0;
        }

        // --- Dashboard Rendering ---
        function renderDashboard() {
            renderWeeklyCompletionChart();
            renderTaskDistributionChart();
            renderBidOriginChart();
            renderCompletedTasksTable();
        }
        
        function renderWeeklyCompletionChart() {
             const completedTasks = allTasks.filter(t => t.completionDate);
             const weeklyData = completedTasks.reduce((acc, task) => {
                const weekStart = dateFns.format(dateFns.startOfWeek(new Date(task.completionDate)), 'yyyy-MM-dd');
                acc[weekStart] = (acc[weekStart] || 0) + 1;
                return acc;
            }, {});

            const sortedWeeks = Object.keys(weeklyData).sort();
            const labels = sortedWeeks.map(w => dateFns.format(new Date(w), 'MMM d'));
            const data = sortedWeeks.map(w => weeklyData[w]);
            
            const chartData = {
                labels,
                datasets: [{
                    label: 'Tasks Completed',
                    data,
                    backgroundColor: 'hsl(var(--primary))',
                    borderColor: 'hsl(var(--accent))',
                    type: 'bar',
                },
                {
                    label: 'Trend',
                    data,
                    borderColor: 'hsl(var(--accent))',
                    type: 'line',
                    fill: false,
                }]
            };

            if(charts.weekly) charts.weekly.destroy();
            charts.weekly = new Chart(document.getElementById('weekly-completion-chart'), { type: 'bar', data: chartData });
        }
        
        function renderTaskDistributionChart() {
            const activeTasks = allTasks.filter(task => task.status.toLowerCase() !== 'done');
            const distribution = settings.workflowCategories
              .filter(cat => cat.name.toLowerCase() !== 'done')
              .map(category => ({
                name: category.name,
                value: activeTasks.filter(task => task.status === category.name).length,
                color: category.color,
              }))
              .filter(item => item.value > 0);

            const chartData = {
                labels: distribution.map(d => d.name),
                datasets: [{
                    data: distribution.map(d => d.value),
                    backgroundColor: distribution.map(d => d.color)
                }]
            };
            if(charts.distribution) charts.distribution.destroy();
            charts.distribution = new Chart(document.getElementById('task-distribution-chart'), { type: 'pie', data: chartData });
        }

        function renderBidOriginChart() {
             const originsData = settings.bidOrigins.map(origin => ({
                name: origin.name,
                value: allTasks.filter(task => task.bidOrigin === origin.name).length
             })).filter(item => item.value > 0);

             const chartData = {
                labels: originsData.map(d => d.name),
                datasets: [{
                    data: originsData.map(d => d.value),
                     backgroundColor: ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#AF19FF']
                }]
            };
            if(charts.origin) charts.origin.destroy();
            charts.origin = new Chart(document.getElementById('bid-origin-chart'), { type: 'doughnut', data: chartData });
        }
        
        function renderCompletedTasksTable(searchTerm = '', sortKey = 'completionDate', sortOrder = 'desc') {
            const tableBody = document.querySelector('#completed-tasks-table tbody');
            let completed = allTasks.filter(t => t.status.toLowerCase() === 'done');

            if (searchTerm) {
                completed = completed.filter(t => 
                    t.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    t.taskid.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }

            completed.sort((a, b) => {
                let valA = a[sortKey];
                let valB = b[sortKey];
                if (sortKey === 'completionDate') { // handle date sorting
                    valA = valA ? new Date(valA) : new Date(0);
                    valB = valB ? new Date(valB) : new Date(0);
                }
                if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
                if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
                return 0;
            });

            tableBody.innerHTML = completed.map(task => `
                <tr>
                    <td>${task.taskid}</td>
                    <td>${task.title}</td>
                    <td>${task.completionDate ? formatDate(task.completionDate) : 'N/A'}</td>
                    <td>${task.remarks || ''}</td>
                </tr>
            `).join('');
        }
        
        let currentSort = { key: 'completionDate', order: 'desc' };
        document.querySelector('#completed-tasks-table thead').addEventListener('click', e => {
            const key = e.target.dataset.sort;
            if (!key) return;

            const order = (key === currentSort.key && currentSort.order === 'asc') ? 'desc' : 'asc';
            currentSort = { key, order };
            const searchTerm = document.getElementById('completed-tasks-search').value;
            renderCompletedTasksTable(searchTerm, key, order);
        });
         document.getElementById('completed-tasks-search').addEventListener('input', e => {
             renderCompletedTasksTable(e.target.value, currentSort.key, currentSort.order);
        });
        
        // --- Settings Rendering ---
        function renderSettings() {
            renderSettingsList(DOMElements.workflowList, settings.workflowCategories, 'workflow');
            renderSettingsList(DOMElements.subcategoryList, settings.subCategories, 'subcategory');
            renderSettingsList(DOMElements.importanceList, settings.importanceLevels, 'importance');
            renderSettingsList(DOMElements.bidOriginList, settings.bidOrigins, 'bid-origin');
        }
        
        function renderSettingsList(ulElement, items, type) {
            ulElement.innerHTML = '';
            items.forEach(item => {
                const li = document.createElement('li');
                li.className = 'settings-list-item';
                li.dataset.itemId = item.id;
                
                let details = `<span class="item-name">${item.name}</span>`;
                if (item.color) {
                    details = `<div class="item-color-preview" style="background-color: ${item.color};"></div>` + details;
                }
                 if (item.parentCategory) {
                    details += `<span class="item-parent" style="margin-left: auto; font-size: 0.8rem; color: #888;">(Parent: ${item.parentCategory})</span>`;
                }

                li.innerHTML = `
                    <div class="item-details">${details}</div>
                    <div class="item-actions">
                        <button class="btn-icon edit-btn" data-type="${type}" data-id="${item.id}">‚úèÔ∏è</button>
                    </div>
                `;
                ulElement.appendChild(li);
            });
            ulElement.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', () => openSettingsModal(btn.dataset.type, btn.dataset.id)));
        }

        // --- Settings Modal ---
        function openSettingsModal(type, id = null) {
            DOMElements.settingsForm.reset();
            DOMElements.settingsForm.dataset.type = type;
            let item = null;
            let collectionName = '';

            // Reset visibility
            DOMElements.settingsColorGroup.classList.add('hidden');
            DOMElements.settingsParentGroup.classList.add('hidden');
            DOMElements.settingsDeleteBtn.classList.add('hidden');

            switch(type) {
                case 'workflow':
                    DOMElements.settingsModalTitle.textContent = id ? 'Edit Workflow Category' : 'New Workflow Category';
                    DOMElements.settingsColorGroup.classList.remove('hidden');
                    collectionName = 'workflowCategories';
                    break;
                case 'subcategory':
                    DOMElements.settingsModalTitle.textContent = id ? 'Edit Sub-Category' : 'New Sub-Category';
                    DOMElements.settingsParentGroup.classList.remove('hidden');
                    populateSelect(DOMElements.settingsParentSelect, settings.workflowCategories.map(c => c.name));
                    collectionName = 'subCategories';
                    break;
                case 'importance':
                    DOMElements.settingsModalTitle.textContent = id ? 'Edit Importance Level' : 'New Importance Level';
                    DOMElements.settingsColorGroup.classList.remove('hidden');
                    collectionName = 'importanceLevels';
                    break;
                case 'bid-origin':
                    DOMElements.settingsModalTitle.textContent = id ? 'Edit Bid Origin' : 'New Bid Origin';
                    collectionName = 'bidOrigins';
                    break;
            }

            if (id) {
                item = settings[collectionName].find(i => i.id === id);
                DOMElements.settingsItemId.value = id;
                DOMElements.settingsNameInput.value = item.name;
                if(item.color) DOMElements.settingsColorInput.value = item.color;
                if(item.parentCategory) DOMElements.settingsParentSelect.value = item.parentCategory;
                DOMElements.settingsDeleteBtn.classList.remove('hidden');
            } else {
                 DOMElements.settingsItemId.value = '';
            }

            DOMElements.settingsModal.classList.add('show');
        }
        
        function closeSettingsModal() {
            DOMElements.settingsModal.classList.remove('show');
        }

        async function handleSaveSettings(e) {
            e.preventDefault();
            const id = DOMElements.settingsItemId.value || generateId();
            const type = DOMElements.settingsForm.dataset.type;
            const name = DOMElements.settingsNameInput.value;
            
            let collectionName = '';
            const newItemData = { id, name };

            switch(type) {
                case 'workflow': 
                    collectionName = 'workflowCategories';
                    newItemData.color = DOMElements.settingsColorInput.value;
                    break;
                case 'subcategory':
                    collectionName = 'subCategories';
                    newItemData.parentCategory = DOMElements.settingsParentSelect.value;
                    break;
                case 'importance':
                    collectionName = 'importanceLevels';
                    newItemData.color = DOMElements.settingsColorInput.value;
                    break;
                case 'bid-origin': collectionName = 'bidOrigins'; break;
            }

            const collection = [...settings[collectionName]];
            const existingIndex = collection.findIndex(i => i.id === id);

            if(existingIndex > -1) {
                collection[existingIndex] = newItemData;
            } else {
                collection.push(newItemData);
            }
            
            try {
                await setDoc(settingsDoc, { ...settings, [collectionName]: collection });
                closeSettingsModal();
            } catch(error) {
                console.error("Error saving settings:", error);
                alert("Failed to save settings.");
            }
        }
        
        async function handleDeleteSettings() {
             const id = DOMElements.settingsItemId.value;
             const type = DOMElements.settingsForm.dataset.type;
             let collectionName = '';
             switch(type) {
                case 'workflow': collectionName = 'workflowCategories'; break;
                case 'subcategory': collectionName = 'subCategories'; break;
                case 'importance': collectionName = 'importanceLevels'; break;
                case 'bid-origin': collectionName = 'bidOrigins'; break;
            }

            if (id && confirm('Are you sure you want to delete this item?')) {
                 const updatedCollection = settings[collectionName].filter(item => item.id !== id);
                 try {
                     await setDoc(settingsDoc, { ...settings, [collectionName]: updatedCollection });
                     closeSettingsModal();
                 } catch(error) {
                    console.error("Error deleting setting:", error);
                    alert("Failed to delete setting.");
                }
            }
        }
        
        // --- Data Management ---
        function handleExportData() {
            const data = JSON.stringify({ settings, tasks: allTasks }, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'task-tracker-data.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function handleImportData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.settings || !data.tasks) {
                        throw new Error("Invalid data format");
                    }

                    // This is a destructive operation. We will overwrite everything.
                    if (!confirm("This will overwrite all current settings and tasks. Are you sure?")) return;
                    
                    const batch = writeBatch(db);

                    // Clear existing tasks
                    const tasksSnapshot = await getDocs(tasksCollection);
                    tasksSnapshot.forEach(doc => batch.delete(doc.ref));

                    // Add new tasks
                    data.tasks.forEach(task => {
                        batch.set(doc(db, 'tasks', task.id), task);
                    });

                    // Set settings
                    batch.set(settingsDoc, data.settings);
                    
                    await batch.commit();
                    alert("Data imported successfully!");

                } catch (error) {
                    console.error("Failed to import data:", error);
                    alert(`Error: ${error.message}`);
                }
            };
            reader.readAsText(file);
        }
        
        async function handleClearTasks() {
            if (!confirm("Are you sure you want to delete ALL tasks permanently?")) return;
            try {
                const tasksSnapshot = await getDocs(tasksCollection);
                const batch = writeBatch(db);
                tasksSnapshot.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                alert("All tasks have been deleted.");
            } catch (error) {
                console.error("Error clearing tasks:", error);
                alert("Failed to clear tasks.");
            }
        }
        
        async function handleResetSettings() {
             if (!confirm("Are you sure you want to reset all settings to their default state?")) return;
             try {
                await setDoc(settingsDoc, defaultSettings);
                alert("Settings have been reset to default.");
             } catch(error) {
                console.error("Error resetting settings:", error);
                alert("Failed to reset settings.");
             }
        }

        // --- Helper Functions ---
        function populateSelect(selectElement, options, placeholder = '') {
            selectElement.innerHTML = placeholder ? `<option value="">${placeholder}</option>` : '';
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                selectElement.appendChild(opt);
            });
        }
        
        function formatDate(isoString) {
            if (!isoString) return 'N/A';
            return dateFns.format(new Date(isoString), 'MMM d, yyyy');
        }

        // --- Event Listeners Setup ---
        function addEventListeners() {
            DOMElements.themeToggle.addEventListener('click', toggleTheme);
            
            // View Toggling
            DOMElements.dashboardToggleBtn.addEventListener('click', () => toggleView('dashboard'));
            DOMElements.settingsToggleBtn.addEventListener('click', () => toggleView('settings'));
            // A bit of a hack to get back to the kanban board
            document.querySelector('.app-header h1').addEventListener('click', () => toggleView('kanban'));
            
            // Kanban Filters
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    currentKanbanFilter = e.target.dataset.filter;
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    renderKanbanBoard();
                });
            });

            // Task Modal
            DOMElements.newTaskBtn.addEventListener('click', () => openTaskModal());
            DOMElements.closeModalBtns.forEach(btn => btn.addEventListener('click', () => {
                DOMElements.taskModal.classList.remove('show');
                DOMElements.settingsModal.classList.remove('show');
            }));
            DOMElements.taskForm.addEventListener('submit', handleSaveTask);
            DOMElements.deleteTaskBtn.addEventListener('click', handleDeleteTask);
            DOMElements.taskStatusInput.addEventListener('change', (e) => updateSubStatusDropdown(e.target.value));

            // Settings
            DOMElements.settingsTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    DOMElements.settingsTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    const tabName = tab.dataset.tab;
                    DOMElements.settingsContents.forEach(content => {
                        content.classList.toggle('active', content.id === `${tabName}-content`);
                    });
                });
            });
            
            // Settings CRUD Buttons
            document.getElementById('add-workflow-btn').addEventListener('click', () => openSettingsModal('workflow'));
            document.getElementById('add-subcategory-btn').addEventListener('click', () => openSettingsModal('subcategory'));
            document.getElementById('add-importance-btn').addEventListener('click', () => openSettingsModal('importance'));
            document.getElementById('add-bid-origin-btn').addEventListener('click', () => openSettingsModal('bid-origin'));
            
            DOMElements.settingsForm.addEventListener('submit', handleSaveSettings);
            DOMElements.settingsDeleteBtn.addEventListener('click', handleDeleteSettings);
            
            // Data Management
            document.getElementById('export-data-btn').addEventListener('click', handleExportData);
            document.getElementById('import-data-btn').addEventListener('click', () => document.getElementById('import-file-input').click());
            document.getElementById('import-file-input').addEventListener('change', handleImportData);
            document.getElementById('clear-tasks-btn').addEventListener('click', handleClearTasks);
            document.getElementById('reset-settings-btn').addEventListener('click', handleResetSettings);
        }

    </script>
</body>
</html>
